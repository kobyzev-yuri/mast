# Анализ координат мастоцитов через Gemini 3 Pro

Скрипт для определения координат мастоцитов и анализа ошибок обнаружения.

## Задача

Этот скрипт расширяет предыдущий анализ (`analyze_mast_cells_gemini.py`) и выполняет три этапа:

1. **Напоминание о предыдущих результатах**: Gemini напоминается о явно и неявно выраженных мастоцитах из предыдущего теста
2. **Определение координат**: Gemini просится определить координаты мастоцитов на картинках с расширением `_no` (без разметки)
3. **Анализ ошибок**: Проводится анализ ошибок на основании тех же картинок с разметкой `_yes` (с разметкой)
4. **Рефлексия и рекомендации**: Выясняется, что нужно Gemini для улучшения обнаружения неявно выраженных мастоцитов

## Структура данных

В директории `MAST_GEMINI/` должны находиться пары изображений:

- `NN_no.png` — неокрашенный патч (гематоксилин-эозин) **БЕЗ разметки**
- `NN_yes.png` — тот же патч, но **С РАЗМЕТКОЙ** мастоцитов:
  - **Зеленым** выделены мастоциты с **явными признаками**
  - **Синим** выделены мастоциты с **не очень явными признаками**

Примеры:
- `01_no.png` / `01_yes.png`
- `02_no.png` / `02_yes.png`
- `03_no.png` / `03_yes.png`

## Установка зависимостей

```bash
pip install httpx python-dotenv pillow
```

## Настройка

Скрипт использует конфигурацию из:
1. `../brats/kb-service/config.env` (приоритет)
2. `../brats/config.env` (резерв)

Необходимые переменные окружения:
- `GEMINI_API_KEY` или `OPENAI_API_KEY` — API ключ для ProxyAPI.ru
- `GEMINI_BASE_URL` (опционально, по умолчанию `https://api.proxyapi.ru/google`)
- `GEMINI_MODEL` (опционально, по умолчанию `gemini-3-pro-preview`)

Пример конфигурации в `kb-service/config.env`:
```env
GEMINI_API_KEY=your_proxyapi_key_here
GEMINI_BASE_URL=https://api.proxyapi.ru/google
GEMINI_MODEL=gemini-3-pro-preview
```

## Использование

```bash
cd /mnt/ai/cnn/sc
python3 analyze_mast_cells_coordinates_gemini.py
```

## Процесс анализа

Скрипт обрабатывает каждую пару изображений (`_no` / `_yes`) в три этапа:

### ЭТАП 1: Определение координат

- Gemini получает изображение `_no` (без разметки)
- Ей напоминается о предыдущих результатах (явные vs неявные мастоциты)
- Задача: найти все мастоциты и определить их координаты
- Для каждого найденного мастоцита указывается:
  - Координаты центра ядра (x, y)
  - Тип: "явный" или "неявный"
  - Уверенность: "высокая", "средняя" или "низкая"
  - Описание визуальных признаков

### ЭТАП 2: Анализ ошибок

- Gemini получает оба изображения (`_no` и `_yes`)
- Сравниваются результаты этапа 1 с реальной разметкой
- Определяются:
  - False Negatives (пропущенные мастоциты)
  - False Positives (неправильно определенные объекты)
- Для каждого пропуска объясняется причина и что нужно для улучшения

### ЭТАП 3: Рефлексия и рекомендации

- Анализируется способность находить неявные мастоциты
- Выясняется, что нужно для улучшения:
  - Больше аннотированных картинок?
  - Другое разрешение?
  - Другие улучшения?
- Формулируются инсайты и практические рекомендации

## Результат

Результаты сохраняются в два файла:

1. **`mast_cells_coordinates_analysis_result.txt`** — текстовый отчет со всеми результатами
2. **`mast_cells_coordinates_analysis_result.json`** — структурированный JSON для программного доступа

**Структура отчета:**
- Общая информация о количестве проанализированных пар
- Для каждой пары отдельный раздел с:
  - Результатами этапа 1 (координаты найденных мастоцитов)
  - Результатами этапа 2 (анализ ошибок)
  - Результатами этапа 3 (рекомендации и инсайты)
- Обобщающий раздел

## Особенности

### Сохранение разрешения

В отличие от предыдущего скрипта, этот скрипт пытается сохранить большее разрешение изображений (до 4096px по большей стороне, до 8 МБ) для более точного определения координат и детального анализа.

### Контекст предыдущего анализа

Скрипт автоматически загружает резюме предыдущего анализа из `mast_cells_analysis_result.txt` и включает его в промпты, чтобы Gemini помнила о явных и неявных признаках мастоцитов.

### Детальный анализ ошибок

Скрипт не просто сравнивает результаты, но и просит Gemini объяснить:
- Почему были пропущены мастоциты
- Какие признаки были недостаточными
- Как можно было бы избежать ошибок

## Вопросы исследования

Этот скрипт помогает ответить на следующие вопросы:

1. **Сможет ли Gemini найти мастоциты по неявным признакам?**
   - Результаты этапа 1 показывают, сколько неявных мастоцитов было найдено

2. **Что нужно для улучшения обнаружения?**
   - Результаты этапа 3 содержат конкретные рекомендации:
     - Нужен ли более широкий набор аннотированных картинок?
     - Поможет ли другое разрешение (в прошлый раз сильно сжимали)?
     - Что еще могло бы помочь?

3. **Появятся ли инсайты?**
   - Результаты этапа 3 содержат новые закономерности и алгоритмы для поиска неявных мастоцитов

## Устранение проблем

### Ошибка 402: Insufficient balance

Если появляется ошибка `402 Payment Required`, это означает недостаточный баланс на ProxyAPI.ru.

**Решения:**
1. Пополните баланс на ProxyAPI.ru
2. Используйте другой API ключ с достаточным балансом

**Примечание:** Этот скрипт использует большее разрешение изображений, что может увеличить стоимость запросов.

### Изображения не найдены

Убедитесь, что директория `MAST_GEMINI/` существует и содержит пары файлов:
- `NN_no.png` и `NN_yes.png` для каждого случая

### Предыдущий анализ не найден

Если файл `mast_cells_analysis_result.txt` не существует, скрипт все равно будет работать, но Gemini не получит контекст о предыдущих результатах. Рекомендуется сначала запустить `analyze_mast_cells_gemini.py`.


