#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ Gemini 3 Pro.

–ó–∞–¥–∞—á–∞:
1. –ù–∞–ø–æ–º–Ω–∏—Ç—å Gemini –æ —è–≤–Ω–æ –∏ –Ω–µ—è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–∞—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ—Å—Ç–∞
2. –ü–æ–ø—Ä–æ—Å–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞—Ö —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º _no
3. –°–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ç–µ—Ö –∂–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π _yes
4. –í—ã—è—Å–Ω–∏—Ç—å, —á—Ç–æ –Ω—É–∂–Ω–æ Gemini –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –Ω–µ—è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤
"""

import os
import sys
import base64
import asyncio
import logging
from pathlib import Path
from typing import List, Dict, Any, Optional
from dotenv import load_dotenv
import httpx
from PIL import Image
import io
import json

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ brats –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ Gemini (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
brats_path = Path(__file__).resolve().parent.parent.parent / "brats" / "kb-service"
if brats_path.exists():
    sys.path.insert(0, str(brats_path))

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ ../brats/config.env –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π config.env
brats_config_path = Path(__file__).resolve().parent.parent.parent / "brats" / "config.env"
kb_service_config_path = Path(__file__).resolve().parent.parent.parent / "brats" / "kb-service" / "config.env"
local_config_path = Path(__file__).resolve().parent / "config.env"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ª–æ–∫–∞–ª—å–Ω—ã–π config.env, –∑–∞—Ç–µ–º kb-service/config.env, –∑–∞—Ç–µ–º brats/config.env)
if local_config_path.exists():
    load_dotenv(dotenv_path=local_config_path, override=True)
if kb_service_config_path.exists():
    load_dotenv(dotenv_path=kb_service_config_path, override=False)
if brats_config_path.exists():
    load_dotenv(dotenv_path=brats_config_path, override=False)

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


class GeminiVisionService:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Gemini 3 Pro Vision API —á–µ—Ä–µ–∑ ProxyAPI.ru"""
    
    def __init__(self):
        api_key = os.getenv("GEMINI_API_KEY") or os.getenv("OPENAI_API_KEY")
        base_url = os.getenv("GEMINI_BASE_URL", "https://api.proxyapi.ru/google")
        self.model = os.getenv("GEMINI_MODEL", "gemini-3-pro-preview")
        self.temperature = float(os.getenv("GEMINI_TEMPERATURE", "0.2"))
        self.timeout = int(os.getenv("GEMINI_TIMEOUT", "120"))
        
        if not api_key:
            raise ValueError(
                "GEMINI_API_KEY –∏–ª–∏ OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. "
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ config.env –≤ kb-service –∏–ª–∏ brats –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏."
            )
        
        self.base_url = base_url.rstrip("/")
        self._client = httpx.AsyncClient(
            base_url=self.base_url,
            timeout=self.timeout,
            headers={
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
            },
        )
        
        logger.info(
            f"‚úÖ GeminiVisionService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (model={self.model}, base_url={self.base_url})"
        )
    
    def _encode_image(self, image_path: Path, max_size_mb: float = 4.0, preserve_resolution: bool = False) -> Dict[str, str]:
        """
        –ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 –¥–ª—è Gemini API.
        –£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ.
        
        Args:
            image_path: –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
            max_size_mb: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤ –ú–ë –ø–æ—Å–ª–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4 –ú–ë)
            preserve_resolution: –ï—Å–ª–∏ True, –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–æ–ª—å—à–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–¥–æ 8 –ú–ë)
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å inline_data –¥–ª—è Gemini API
        """
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
        mime_type = "image/png" if image_path.suffix.lower() == ".png" else "image/jpeg"
        
        # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç
        if preserve_resolution:
            max_size_mb = 8.0
            max_dimension = 4096
        else:
            max_dimension = 2048
        
        # –ß–∏—Ç–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        with Image.open(image_path) as img:
            original_width, original_height = img.size
            logger.info(f"üìê –ò—Å—Ö–æ–¥–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ {image_path.name}: {original_width}x{original_height}")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–¥–ª—è PNG —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º)
            if img.mode in ('RGBA', 'LA', 'P'):
                background = Image.new('RGB', img.size, (255, 255, 255))
                if img.mode == 'P':
                    img = img.convert('RGBA')
                background.paste(img, mask=img.split()[-1] if img.mode in ('RGBA', 'LA') else None)
                img = background
            elif img.mode != 'RGB':
                img = img.convert('RGB')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∏ —É–º–µ–Ω—å—à–∞–µ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            original_size_mb = os.path.getsize(image_path) / (1024 * 1024)
            logger.debug(f"–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {image_path.name}: {original_size_mb:.2f} –ú–ë")
            
            # –£–º–µ–Ω—å—à–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ
            quality = 95
            
            # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ–ª—å—à–æ–µ, —É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ
            if img.width > max_dimension or img.height > max_dimension:
                ratio = min(max_dimension / img.width, max_dimension / img.height)
                new_width = int(img.width * ratio)
                new_height = int(img.height * ratio)
                img = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
                logger.info(f"üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {image_path.name} —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ {new_width}x{new_height}")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—É—Ñ–µ—Ä —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∫–∞—á–µ—Å—Ç–≤–∞
            buffer = io.BytesIO()
            img.save(buffer, format='JPEG', quality=quality, optimize=True)
            image_data = buffer.getvalue()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
            encoded_size_mb = len(image_data) / (1024 * 1024)
            logger.debug(f"–†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ {image_path.name}: {encoded_size_mb:.2f} –ú–ë")
            
            # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, —É–º–µ–Ω—å—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
            if encoded_size_mb > max_size_mb:
                for q in [85, 75, 65, 55]:
                    buffer = io.BytesIO()
                    img.save(buffer, format='JPEG', quality=q, optimize=True)
                    test_data = buffer.getvalue()
                    if len(test_data) / (1024 * 1024) <= max_size_mb:
                        image_data = test_data
                        logger.info(f"üñºÔ∏è –ö–∞—á–µ—Å—Ç–≤–æ {image_path.name} —Å–Ω–∏–∂–µ–Ω–æ –¥–æ {q}% –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞")
                        break
        
        return {
            "inline_data": {
                "mime_type": "image/jpeg",  # –í—Å–µ–≥–¥–∞ JPEG –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                "data": base64.b64encode(image_data).decode("utf-8")
            }
        }
    
    async def analyze_images(
        self,
        image_paths: List[Path],
        prompt: str,
        system_prompt: Optional[str] = None,
        image_labels: Optional[List[str]] = None,
        preserve_resolution: bool = False,
    ) -> str:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini Vision API.
        
        Args:
            image_paths: –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            image_labels: –ú–µ—Ç–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –ø—Ä–æ–º–ø—Ç–µ)
            preserve_resolution: –°–æ—Ö—Ä–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        
        Returns:
            –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini
        """
        # –§–æ—Ä–º–∏—Ä—É–µ–º parts: —Å–Ω–∞—á–∞–ª–∞ —Ç–µ–∫—Å—Ç, –∑–∞—Ç–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        parts = [{"text": prompt}]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        for idx, img_path in enumerate(image_paths):
            if not img_path.exists():
                logger.warning(f"‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: {img_path}")
                continue
            parts.append(self._encode_image(img_path, preserve_resolution=preserve_resolution))
        
        request_data: Dict[str, Any] = {
            "contents": [{"parts": parts}],
            "generationConfig": {
                "temperature": self.temperature,
                "maxOutputTokens": 8192,  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            },
        }
        
        if system_prompt:
            request_data["systemInstruction"] = {
                "parts": [{"text": system_prompt}],
            }
        
        model_endpoint = f"/v1beta/models/{self.model}:generateContent"
        
        try:
            logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini —Å {len(image_paths)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏...")
            response = await self._client.post(
                model_endpoint,
                json=request_data,
                timeout=self.timeout,
            )
            response.raise_for_status()
            data = response.json()
            
            candidates = data.get("candidates", []) or []
            if not candidates:
                logger.warning("‚ö†Ô∏è Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ candidates")
                return "–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏"
            
            content = candidates[0].get("content", {})
            parts_out = content.get("parts", []) or []
            if not parts_out:
                logger.warning("‚ö†Ô∏è Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ parts –≤ content")
                return "–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –æ—Ç–≤–µ—Ç–µ"
            
            text = parts_out[0].get("text", "") or ""
            if not text:
                logger.warning("‚ö†Ô∏è Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π text")
                return "–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –≤ –æ—Ç–≤–µ—Ç–µ"
            
            return text
        
        except httpx.HTTPStatusError as e:
            error_text = e.response.text
            logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {e.response.status_code} - {error_text}")
            
            # –î–ª—è –æ—à–∏–±–∫–∏ 402 –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
            if e.response.status_code == 402:
                return f"ERROR_402: {error_text}"
            
            return f"–û—à–∏–±–∫–∞ HTTP {e.response.status_code}: {error_text}"
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini: {e}", exc_info=True)
            return f"–û—à–∏–±–∫–∞: {str(e)}"
    
    async def close(self):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç HTTP –∫–ª–∏–µ–Ω—Ç"""
        await self._client.aclose()


def load_previous_analysis_summary() -> str:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
    result_file = Path(__file__).parent / "results" / "mast_cells_analysis_result.txt"
    if result_file.exists():
        with open(result_file, "r", encoding="utf-8") as f:
            content = f.read()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        summary = """
–ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:

–ò–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ—Å—Ç–∞ —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å –æ –º–∞—Å—Ç–æ—Ü–∏—Ç–∞—Ö —Å–ª–µ–¥—É—é—â–µ–µ:

1. –Ø–í–ù–û –í–´–†–ê–ñ–ï–ù–ù–´–ï –ú–ê–°–¢–û–¶–ò–¢–´ (–∑–µ–ª–µ–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏):
   - –û–∫—Ä—É–≥–ª–∞—è –∏–ª–∏ —Å–ª–µ–≥–∫–∞ –æ–≤–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞
   - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–µ, –æ–∫—Ä—É–≥–ª–æ–µ –∏–ª–∏ –æ–≤–∞–ª—å–Ω–æ–µ —è–¥—Ä–æ —Ç–µ–º–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ —Ü–≤–µ—Ç–∞
   - –≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—å–Ω–∞—è (—Ä–æ–∑–æ–≤–∞—Ç–∞—è) –∑–µ—Ä–Ω–∏—Å—Ç–∞—è —Ü–∏—Ç–æ–ø–ª–∞–∑–º–∞ –≤–æ–∫—Ä—É–≥ —è–¥—Ä–∞
   - –ß–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã, —Ö–æ—Ä–æ—à–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç —Å —Ñ–æ–Ω–æ–º
   - –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–º–µ (—Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ç–∫–∞–Ω–∏) –º–µ–∂–¥—É –∫—Ä–∏–ø—Ç–∞–º–∏
   - –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑: "–≥–ª–∞–∑—É–Ω—å—è" - —Ç–µ–º–Ω—ã–π "–∂–µ–ª—Ç–æ–∫" (—è–¥—Ä–æ) –∏ –º—É—Ç–Ω–æ–≤–∞—Ç—ã–π —Ä–æ–∑–æ–≤—ã–π "–±–µ–ª–æ–∫" (—Ü–∏—Ç–æ–ø–ª–∞–∑–º–∞)

2. –ù–ï–Ø–í–ù–û –í–´–†–ê–ñ–ï–ù–ù–´–ï –ú–ê–°–¢–û–¶–ò–¢–´ (—Å–∏–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏):
   - –û–≤–∞–ª—å–Ω–∞—è –∏–ª–∏ —Å–ª–µ–≥–∫–∞ –≤—ã—Ç—è–Ω—É—Ç–∞—è —Ñ–æ—Ä–º–∞
   - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–µ —è–¥—Ä–æ (–∫–ª—é—á–µ–≤–æ–π –ø—Ä–∏–∑–Ω–∞–∫ –¥–ª—è –æ—Ç–ª–∏—á–∏—è –æ—Ç –ø–ª–∞–∑–º–æ—Ü–∏—Ç–æ–≤)
   - –†–æ–∑–æ–≤–∞—è —Ü–∏—Ç–æ–ø–ª–∞–∑–º–∞, –Ω–æ —Å —Ä–∞–∑–º—ã—Ç—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
   - –ó–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å –ø–ª–æ—Ö–æ —Ä–∞–∑–ª–∏—á–∏–º–∞ –∏–ª–∏ –Ω–µ –≤–∏–¥–Ω–∞
   - –°–ª–∏–≤–∞—é—Ç—Å—è —Å —Ñ–æ–Ω–æ–º, –Ω–∏–∑–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
   - –õ–µ–≥–∫–æ —Å–ø—É—Ç–∞—Ç—å —Å —Ñ–∏–±—Ä–æ–±–ª–∞—Å—Ç–∞–º–∏, –≥–∏—Å—Ç–∏–æ—Ü–∏—Ç–∞–º–∏ –∏–ª–∏ –º–∞–∫—Ä–æ—Ñ–∞–≥–∞–º–∏
   - –ú–æ–≥—É—Ç –±—ã—Ç—å –≤–µ—Ä–µ—Ç–µ–Ω–æ–≤–∏–¥–Ω–æ–π —Ñ–æ—Ä–º—ã (–º–∏–º–∏–∫—Ä–∏—Ä—É—é—Ç –ø–æ–¥ —Ñ–∏–±—Ä–æ–±–ª–∞—Å—Ç—ã)

3. –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ó–ù–ê–ö–ò –î–õ–Ø –û–¢–õ–ò–ß–ï–ù–ò–Ø:
   - –û—Ç –ø–ª–∞–∑–º–æ—Ü–∏—Ç–æ–≤: —É –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —è–¥—Ä–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É, —É –ø–ª–∞–∑–º–æ—Ü–∏—Ç–æ–≤ - —Å–¥–≤–∏–Ω—É—Ç–æ –∫ –∫—Ä–∞—é
   - –û—Ç –ª–∏–º—Ñ–æ—Ü–∏—Ç–æ–≤: —É –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ –µ—Å—Ç—å –æ–±–æ–¥–æ–∫ —Ä–æ–∑–æ–≤–æ–π —Ü–∏—Ç–æ–ø–ª–∞–∑–º—ã, —É –ª–∏–º—Ñ–æ—Ü–∏—Ç–æ–≤ —Ü–∏—Ç–æ–ø–ª–∞–∑–º—ã –ø–æ—á—Ç–∏ –Ω–µ—Ç
   - –û—Ç —Ñ–∏–±—Ä–æ–±–ª–∞—Å—Ç–æ–≤: —É –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —è–¥—Ä–æ –æ–∫—Ä—É–≥–ª–æ–µ, —É —Ñ–∏–±—Ä–æ–±–ª–∞—Å—Ç–æ–≤ - –≤—ã—Ç—è–Ω—É—Ç–æ–µ –≤–µ—Ä–µ—Ç–µ–Ω–æ–≤–∏–¥–Ω–æ–µ

4. –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:
   - –ù–∞ –≥/—ç —É–≤–µ—Ä–µ–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–ª–∏—Å—å —Ç–æ–ª—å–∫–æ "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ" –º–∞—Å—Ç–æ—Ü–∏—Ç—ã
   - –ß–∞—Å—Ç—å –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —Ç–µ—Ä—è–ª–∞—Å—å (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–µ–≥—Ä–∞–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å—Ä–µ–∑–∞–Ω–Ω—ã—Ö –ø–æ –∫—Ä–∞—é)
   - –ò–ì–• –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ –±–æ–ª—å—à–µ –∫–ª–µ—Ç–æ–∫, —á–µ–º –±—ã–ª–æ –≤–∏–¥–Ω–æ –Ω–∞ –≥/—ç
   - –î–ª—è –Ω–µ—è–≤–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —Ç—Ä–µ–±–æ–≤–∞–ª—Å—è –ò–ì–• –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–ª—è 100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
"""
        return summary
    return ""


async def analyze_coordinates_and_errors():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ –æ—à–∏–±–æ–∫"""
    
    # –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    mast_dir = Path(__file__).parent / "data" / "MAST_GEMINI"
    
    if not mast_dir.exists():
        logger.error(f"‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {mast_dir}")
        return
    
    # –ù–∞—Ö–æ–¥–∏–º –ø–∞—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π _no –∏ _yes
    images_no = sorted(mast_dir.glob("*_no.png"))
    images_yes = sorted(mast_dir.glob("*_yes.png"))
    
    logger.info(f"–ù–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π _no: {len(images_no)}")
    logger.info(f"–ù–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π _yes: {len(images_yes)}")
    
    if not images_no:
        logger.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º _no")
        return
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç Gemini
    try:
        gemini = GeminiVisionService()
    except ValueError as e:
        logger.error(f"‚ùå {e}")
        return
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—é–º–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    previous_summary = load_previous_analysis_summary()
    
    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    system_prompt = """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–ø–∞—Ç–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –≥–∏—Å—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ –º–∞—Å—Ç–æ—Ü–∏—Ç—ã –Ω–∞ –Ω–µ–æ–∫—Ä–∞—à–µ–Ω–Ω—ã—Ö –ø–∞—Ç—á–∞—Ö (–≥–µ–º–∞—Ç–æ–∫—Å–∏–ª–∏–Ω-—ç–æ–∑–∏–Ω) –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.
–¢—ã —É–∂–µ –∑–Ω–∞–µ—à—å –æ —è–≤–Ω–æ –∏ –Ω–µ—è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–∞—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–∏ –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤."""
    
    results = []
    
    try:
        for img_no in images_no:
            # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ _yes
            img_yes = None
            base_name = img_no.stem.replace("_no", "")
            for yes_img in images_yes:
                if yes_img.stem.replace("_yes", "") == base_name:
                    img_yes = yes_img
                    break
            
            if not img_yes:
                logger.warning(f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ _yes –¥–ª—è {img_no.name}")
                continue
            
            logger.info(f"\n{'='*80}")
            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä—ã: {img_no.name} / {img_yes.name}")
            logger.info(f"{'='*80}\n")
            
            # –≠–¢–ê–ü 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ _no –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
            prompt_step1 = f"""{previous_summary}

–ó–ê–î–ê–ß–ê –≠–¢–ê–ü–ê 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ö–û–û–†–î–ò–ù–ê–¢ –ú–ê–°–¢–û–¶–ò–¢–û–í

–¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {img_no.name} - —ç—Ç–æ –Ω–µ–æ–∫—Ä–∞—à–µ–Ω–Ω—ã–π –ø–∞—Ç—á (–≥–µ–º–∞—Ç–æ–∫—Å–∏–ª–∏–Ω-—ç–æ–∑–∏–Ω) –ë–ï–ó —Ä–∞–∑–º–µ—Ç–∫–∏.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –Ω–∞–π–¥–∏ –í–°–ï –º–∞—Å—Ç–æ—Ü–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –º–æ–∂–µ—à—å –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–æ—Ü–∏—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–∏:
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ —è–¥—Ä–∞ (x, y) –≤ –ø–∏–∫—Å–µ–ª—è—Ö
   - –¢–∏–ø: "—è–≤–Ω—ã–π" –∏–ª–∏ "–Ω–µ—è–≤–Ω—ã–π" (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –æ–ø–∏—Å–∞–ª —Ä–∞–Ω–µ–µ)
   - –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: "–≤—ã—Å–æ–∫–∞—è", "—Å—Ä–µ–¥–Ω—è—è" –∏–ª–∏ "–Ω–∏–∑–∫–∞—è"
   - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Ç—ã –µ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª

3. –í–ê–ñ–ù–û: –ü–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–∞–π—Ç–∏ –Ω–µ —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–µ –º–∞—Å—Ç–æ—Ü–∏—Ç—ã, –Ω–æ –∏ –Ω–µ—è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–µ (—Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ, —Å –Ω–∏–∑–∫–∏–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–æ—Ü–∏—Ç–∞ —É–∫–∞–∂–∏:
- –ú–∞—Å—Ç–æ—Ü–∏—Ç #N: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (x, y), —Ç–∏–ø: [—è–≤–Ω—ã–π/–Ω–µ—è–≤–Ω—ã–π], —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: [–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è]
  –ü—Ä–∏–∑–Ω–∞–∫–∏: [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ]

–ï—Å–ª–∏ –º–∞—Å—Ç–æ—Ü–∏—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ –∏ –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É.

–ü–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª:
"–û–ë–©–ò–ï –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø:"
- –°–∫–æ–ª—å–∫–æ –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ –≤—Å–µ–≥–æ
- –°–∫–æ–ª—å–∫–æ —è–≤–Ω—ã—Ö –∏ —Å–∫–æ–ª—å–∫–æ –Ω–µ—è–≤–Ω—ã—Ö
- –ö–∞–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±—ã–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
- –ß—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–ª–æ –ø–æ–∏—Å–∫ (–µ—Å–ª–∏ –±—ã–ª–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏)
"""
            
            logger.info("üì§ –≠–¢–ê–ü 1: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...")
            result_step1 = await gemini.analyze_images(
                image_paths=[img_no],
                prompt=prompt_step1,
                system_prompt=system_prompt,
                preserve_resolution=True,  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            )
            
            # –≠–¢–ê–ü 2: –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º _yes –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            prompt_step2 = f"""{previous_summary}

–ó–ê–î–ê–ß–ê –≠–¢–ê–ü–ê 2: –ê–ù–ê–õ–ò–ó –û–®–ò–ë–û–ö

–¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –î–í–ê –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
1. {img_no.name} - –Ω–µ–æ–∫—Ä–∞—à–µ–Ω–Ω—ã–π –ø–∞—Ç—á –ë–ï–ó —Ä–∞–∑–º–µ—Ç–∫–∏ (—Ç–æ—Ç –∂–µ, —á—Ç–æ –Ω–∞ —ç—Ç–∞–ø–µ 1)
2. {img_yes.name} - —Ç–æ—Ç –∂–µ –ø–∞—Ç—á, –Ω–æ –° –†–ê–ó–ú–ï–¢–ö–û–ô –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤

–ù–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ {img_yes.name}:
- –ó–µ–ª–µ–Ω—ã–º –≤—ã–¥–µ–ª–µ–Ω—ã –º–∞—Å—Ç–æ—Ü–∏—Ç—ã —Å –Ø–í–ù–´–ú–ò –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
- –°–∏–Ω–∏–º –≤—ã–¥–µ–ª–µ–Ω—ã –º–∞—Å—Ç–æ—Ü–∏—Ç—ã —Å –ù–ï –û–ß–ï–ù–¨ –Ø–í–ù–´–ú–ò –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –°—Ä–∞–≤–Ω–∏ —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —ç—Ç–∞–ø–∞ 1 —Å —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π –Ω–∞ {img_yes.name}

2. –û–ø—Ä–µ–¥–µ–ª–∏:
   - –°–ö–û–õ–¨–ö–û –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —Ç—ã –ù–ê–®–ï–õ –Ω–∞ —ç—Ç–∞–ø–µ 1
   - –°–ö–û–õ–¨–ö–û –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ –†–ï–ê–õ–¨–ù–û –µ—Å—Ç—å –Ω–∞ —Ä–∞–∑–º–µ—Ç–∫–µ (–∑–µ–ª–µ–Ω—ã–µ + —Å–∏–Ω–∏–µ)
   - –°–ö–û–õ–¨–ö–û –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —Ç—ã –ü–†–û–ü–£–°–¢–ò–õ (False Negatives)
   - –°–ö–û–õ–¨–ö–û –æ–±—ä–µ–∫—Ç–æ–≤ —Ç—ã –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–∞–∫ –º–∞—Å—Ç–æ—Ü–∏—Ç—ã (False Positives, –µ—Å–ª–∏ –±—ã–ª–∏)

3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ü–†–û–ü–£–©–ï–ù–ù–û–ì–û –º–∞—Å—Ç–æ—Ü–∏—Ç–∞ (–∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –≤ —Ä–∞–∑–º–µ—Ç–∫–µ, –Ω–æ —Ç—ã –Ω–µ –Ω–∞—à–µ–ª):
   - –£–∫–∞–∂–∏ –µ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Ä–∞–∑–º–µ—Ç–∫–∏
   - –û–±—ä—è—Å–Ω–∏, –ü–û–ß–ï–ú–£ —Ç—ã –µ–≥–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª (—Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏, —Å–ª–∏–ª—Å—è —Å —Ñ–æ–Ω–æ–º, –ø–æ—Ö–æ–∂ –Ω–∞ –¥—Ä—É–≥—É—é –∫–ª–µ—Ç–∫—É –∏ —Ç.–¥.)
   - –û–ø–∏—à–∏, –∫–∞–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±—ã–ª–∏ –±—ã –Ω—É–∂–Ω—ã, —á—Ç–æ–±—ã –µ–≥–æ –Ω–∞–π—Ç–∏

4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –û–ü–†–ï–î–ï–õ–ï–ù–ù–û–ì–û –æ–±—ä–µ–∫—Ç–∞ (–µ—Å–ª–∏ –±—ã–ª–∏):
   - –£–∫–∞–∂–∏ –µ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
   - –û–±—ä—è—Å–Ω–∏, –Ω–∞ —á—Ç–æ –æ–Ω –ø–æ—Ö–æ–∂ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ (—Ñ–∏–±—Ä–æ–±–ª–∞—Å—Ç, –ø–ª–∞–∑–º–æ—Ü–∏—Ç, –ª–∏–º—Ñ–æ—Ü–∏—Ç –∏ —Ç.–¥.)
   - –û–ø–∏—à–∏, –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏

5. –û–ë–©–ò–ô –ê–ù–ê–õ–ò–ó:
   - –ö–∞–∫–∏–µ —Ç–∏–ø—ã –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤ —Ç—ã –Ω–∞—Ö–æ–¥–∏–ª –ª—É—á—à–µ (—è–≤–Ω—ã–µ –∏–ª–∏ –Ω–µ—è–≤–Ω—ã–µ)?
   - –ö–∞–∫–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±—ã–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º–∏?
   - –ö–∞–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –¥–ª—è –Ω–µ—è–≤–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤?

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª—É—á–∞—è.
"""
            
            logger.info("üì§ –≠–¢–ê–ü 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫...")
            result_step2 = await gemini.analyze_images(
                image_paths=[img_no, img_yes],
                prompt=prompt_step2,
                system_prompt=system_prompt,
                preserve_resolution=True,
            )
            
            # –≠–¢–ê–ü 3: –í–æ–ø—Ä–æ—Å—ã –æ —Ç–æ–º, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
            prompt_step3 = f"""{previous_summary}

–ó–ê–î–ê–ß–ê –≠–¢–ê–ü–ê 3: –†–ï–§–õ–ï–ö–°–ò–Ø –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç—Ç–∞–ø–æ–≤ 1 –∏ 2, –æ—Ç–≤–µ—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:

1. –°–ú–û–ì –õ–ò –¢–´ –ù–ê–ô–¢–ò –ù–ï–Ø–í–ù–û –í–´–†–ê–ñ–ï–ù–ù–´–ï –ú–ê–°–¢–û–¶–ò–¢–´?
   - –î–∞/–ù–µ—Ç/–ß–∞—Å—Ç–∏—á–Ω–æ
   - –ï—Å–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ –∏–ª–∏ –Ω–µ—Ç - –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –Ω–µ—è–≤–Ω—ã–µ –º–∞—Å—Ç–æ—Ü–∏—Ç—ã —Ç—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∏ –ø–æ—á–µ–º—É

2. –ß–¢–û –¢–ï–ë–ï –ù–£–ñ–ù–û –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø –û–ë–ù–ê–†–£–ñ–ï–ù–ò–Ø –ù–ï–Ø–í–ù–´–• –ú–ê–°–¢–û–¶–ò–¢–û–í?
   
   –∞) –ë–û–õ–¨–®–ï –ê–ù–ù–û–¢–ò–†–û–í–ê–ù–ù–´–• –ö–ê–†–¢–ò–ù–û–ö?
   - –ü–æ–º–æ–≥–ª–æ –±—ã —Ç–µ–±–µ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π?
   - –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω—É–∂–Ω–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è?
   - –ö–∞–∫–∏–µ —Ç–∏–ø—ã –ø—Ä–∏–º–µ—Ä–æ–≤ –±—ã–ª–∏ –±—ã –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã (–±–æ–ª—å—à–µ –Ω–µ—è–≤–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤, —Ä–∞–∑–Ω—ã–µ —Å—Ç–∞–¥–∏–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏ —Ç.–¥.)?
   
   –±) –î–†–£–ì–û–ï –†–ê–ó–†–ï–®–ï–ù–ò–ï?
   - –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–µ—è–≤–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤?
   - –ù—É–∂–Ω–æ –ª–∏ –±–æ–ª—å—à–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π)?
   - –ò–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç, –º–µ–Ω—å—à–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É?
   - –í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∏–ª—å–Ω–æ —Å–∂–∏–º–∞–ª–∏ - –ø–æ–≤–ª–∏—è–ª–æ –ª–∏ —ç—Ç–æ –Ω–∞ —Ç–≤–æ—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–µ—è–≤–Ω—ã–µ –º–∞—Å—Ç–æ—Ü–∏—Ç—ã?
   
   –≤) –î–†–£–ì–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø?
   - –ù—É–∂–Ω—ã –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø—ã –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è?
   - –ü–æ–º–æ–≥–ª–∏ –±—ã —Ç–µ–±–µ –æ–ø–∏—Å–∞–Ω–∏—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–æ–≤?
   - –ù—É–∂–Ω—ã –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–¥–µ –∏—Å–∫–∞—Ç—å –º–∞—Å—Ç–æ—Ü–∏—Ç—ã –≤ —Ç–∫–∞–Ω–∏)?
   - –ß—Ç–æ –µ—â–µ –º–æ–≥–ª–æ –±—ã –ø–æ–º–æ—á—å?

3. –ü–û–Ø–í–ò–õ–ò–°–¨ –õ–ò –£ –¢–ï–ë–Ø –ò–ù–°–ê–ô–¢–´?
   - –ö–∞–∫–∏–µ –Ω–æ–≤—ã–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ —Ç—ã –∑–∞–º–µ—Ç–∏–ª –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –Ω–µ—è–≤–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤?
   - –ï—Å—Ç—å –ª–∏ –∫–∞–∫–∏–µ-—Ç–æ "—Å–∫—Ä—ã—Ç—ã–µ" –ø—Ä–∏–∑–Ω–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—á–µ–≤–∏–¥–Ω—ã, –Ω–æ –ø–æ–º–æ–≥–∞—é—Ç?
   - –ú–æ–∂–µ—à—å –ª–∏ —Ç—ã —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º –∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–µ—è–≤–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤?
   - –ß—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–ø—É—Å–∫–∞?

4. –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
   - –ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑–º–µ—Ç–∫–∏/–æ–±—É—á–µ–Ω–∏—è, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–µ—è–≤–Ω—ã—Ö –º–∞—Å—Ç–æ—Ü–∏—Ç–æ–≤?
   - –ö–∞–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –±—ã–ª–∏ –±—ã –ø–æ–ª–µ–∑–Ω—ã?
   - –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –±—ã–ª –±—ã –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –¥–ª—è –æ–±—É—á–µ–Ω–∏—è?

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è–º–∏.
"""
            
            logger.info("üì§ –≠–¢–ê–ü 3: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...")
            result_step3 = await gemini.analyze_images(
                image_paths=[img_no, img_yes],
                prompt=prompt_step3,
                system_prompt=system_prompt,
                preserve_resolution=True,
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã
            results.append({
                "image_no": img_no.name,
                "image_yes": img_yes.name,
                "step1_coordinates": result_step1,
                "step2_error_analysis": result_step2,
                "step3_recommendations": result_step3,
            })
            
            logger.info(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä—ã {img_no.name} –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        full_result = []
        full_result.append("="*80)
        full_result.append("–ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢: –ê–ù–ê–õ–ò–ó –ö–û–û–†–î–ò–ù–ê–¢ –ò –û–®–ò–ë–û–ö –ú–ê–°–¢–û–¶–ò–¢–û–í")
        full_result.append("="*80)
        full_result.append(f"\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–∞—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {len(results)}")
        full_result.append(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π _no (–±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏): {len(images_no)}")
        full_result.append(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π _yes (—Å —Ä–∞–∑–º–µ—Ç–∫–æ–π): {len(images_yes)}\n")
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ
        for idx, result in enumerate(results, 1):
            full_result.append("\n" + "="*80)
            full_result.append(f"–ü–ê–†–ê #{idx}: {result['image_no']} / {result['image_yes']}")
            full_result.append("="*80)
            
            full_result.append("\n" + "-"*80)
            full_result.append("–≠–¢–ê–ü 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ö–û–û–†–î–ò–ù–ê–¢ –ú–ê–°–¢–û–¶–ò–¢–û–í")
            full_result.append("-"*80)
            full_result.append(result['step1_coordinates'])
            
            full_result.append("\n" + "-"*80)
            full_result.append("–≠–¢–ê–ü 2: –ê–ù–ê–õ–ò–ó –û–®–ò–ë–û–ö")
            full_result.append("-"*80)
            full_result.append(result['step2_error_analysis'])
            
            full_result.append("\n" + "-"*80)
            full_result.append("–≠–¢–ê–ü 3: –†–ï–§–õ–ï–ö–°–ò–Ø –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò")
            full_result.append("-"*80)
            full_result.append(result['step3_recommendations'])
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–æ–±—â–∞—é—â–∏–π —Ä–∞–∑–¥–µ–ª
        full_result.append("\n" + "="*80)
        full_result.append("–û–ë–û–ë–©–ï–ù–ò–ï –ü–û –í–°–ï–ú –ü–ê–†–ê–ú")
        full_result.append("="*80)
        full_result.append("\n(–°–º. –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ –≤—ã—à–µ)")
        
        result_text = "\n".join(full_result)
        
        print("\n" + "="*80)
        print("–†–ï–ó–£–õ–¨–¢–ê–¢ –ê–ù–ê–õ–ò–ó–ê –ö–û–û–†–î–ò–ù–ê–¢ –ò –û–®–ò–ë–û–ö:")
        print("="*80)
        print(result_text)
        print("="*80 + "\n")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª
        results_dir = Path(__file__).parent / "results"
        results_dir.mkdir(exist_ok=True)
        output_file = results_dir / "mast_cells_coordinates_analysis_result.txt"
        with open(output_file, "w", encoding="utf-8") as f:
            f.write(result_text)
            f.write("\n" + "="*80 + "\n")
        
        logger.info(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_file}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –≤ JSON –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        json_output_file = results_dir / "mast_cells_coordinates_analysis_result.json"
        with open(json_output_file, "w", encoding="utf-8") as f:
            json.dump(results, f, ensure_ascii=False, indent=2)
        
        logger.info(f"‚úÖ JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {json_output_file}")
        
    finally:
        await gemini.close()


if __name__ == "__main__":
    asyncio.run(analyze_coordinates_and_errors())


