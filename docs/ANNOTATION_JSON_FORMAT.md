# Формат входного JSON разметки для конвейера KB

Конвейер `pipeline_annotations_to_kb.py` строит KB на основе **вашего JSON** и изображений **без разметки** (`_no`). Вы можете готовить JSON вручную, экспортировать из своего редактора разметки или из скрипта экспорта из `_yes.png`.

## Структура файла

```json
{
  "schema": {
    "version": "1.0",
    "annotation_type": "bbox",
    "classes": ["explicit", "implicit"],
    "bbox_format": { "x": "px", "y": "px", "w": "px", "h": "px" }
  },
  "items": [
    {
      "image": "имя_файла_с_разметкой.png",
      "annotations": [
        {
          "id": "уникальный_id_аннотации",
          "class": "explicit",
          "bbox": { "x": 100, "y": 200, "w": 50, "h": 60 }
        }
      ]
    }
  ]
}
```

## Обязательные поля

| Уровень | Поле | Тип | Описание |
|--------|------|-----|----------|
| корень | `items` | массив | Список изображений и их аннотаций. |
| `items[]` | `image` | строка | Имя файла изображения (например `1_yes.png` или `slide_001.png`). По нему определяется имя соответствующего `_no` (см. ниже). |
| `items[]` | `annotations` | массив | Список объектов разметки для этого изображения. |
| `annotations[]` | `id` | строка | Уникальный идентификатор аннотации (в рамках всего файла). Используется как ID примера в KB и как имя файла кропа (`{id}.png`). |
| `annotations[]` | `class` | строка | Класс клетки: `"explicit"` (явный мастоцит) или `"implicit"` (неявный). По умолчанию в конвейере считается `explicit`, если не указано. |
| `annotations[]` | `bbox` | объект | Прямоугольник в пикселях: `x`, `y` — левый верхний угол, `w`, `h` — ширина и высота. Координаты относятся к изображению **без разметки** (`_no`), если размеры `_no` и изображения с разметкой совпадают. |

## Как конвейер находит `_no`

- Берётся имя из `items[].image`, например `1_yes.png` или `slide_001.png`.
- От имени отбрасывается расширение и суффикс `_yes` (если есть): получается **base** (`1`, `slide_001`).
- Файл без разметки ищется в **той же директории, где лежит JSON**, с именем `{base}_no.png` (например `1_no.png`, `slide_001_no.png`).

Значит, в одной папке с JSON должны лежать:
- ваш JSON;
- файлы `*_no.png` с именами, построенными по правилу выше.

Поле `items[].image_path` опционально: если его нет, путь к изображению считается как `(директория JSON) / image`.

## Опциональные поля

- `items[].image_path` — путь к файлу изображения (если не задан, используется `image` и директория JSON).
- `items[].width`, `items[].height` — для справки, конвейер не использует.
- `annotations[].color`, `annotations[].pixels`, `annotations[].source` — для совместимости с экспортом из `_yes`, конвейер не использует.
- `schema` — опционально; конвейер читает только `items`.

## Минимальный пример (одно изображение, два объекта)

```json
{
  "items": [
    {
      "image": "1_yes.png",
      "annotations": [
        {
          "id": "1_yes_cell1",
          "class": "explicit",
          "bbox": { "x": 400, "y": 300, "w": 80, "h": 90 }
        },
        {
          "id": "1_yes_cell2",
          "class": "implicit",
          "bbox": { "x": 600, "y": 350, "w": 70, "h": 75 }
        }
      ]
    }
  ]
}
```

В папке с этим JSON должен быть файл `1_no.png` того же размера, что и исходное изображение разметки (координаты bbox относятся к нему).

## Использование с конвейером

```bash
python scripts/pipeline_annotations_to_kb.py \
  --annotations /path/to/your/annotations.json \
  --crops_dir /path/to/crops \
  --kb_path ./mast_cells_kb
```

Только кропы (без записи в KB):

```bash
python scripts/pipeline_annotations_to_kb.py \
  --annotations /path/to/your/annotations.json \
  --crops_dir /path/to/crops \
  --crops_only
```

Конвейер для каждой аннотации:
1. Открывает соответствующий `_no.png` по правилу имён выше.
2. Вырезает кроп по `bbox` (с отступом).
3. Сохраняет кроп в `crops_dir` как `{id}.png`.
4. При необходимости добавляет пример в KB с `cell_type` и метаданными.

**Что попадает в KB:** см. `docs/KB_DATA_STRUCTURE.md` — там описано, как JSON аннотации преобразуются в векторные эмбеддинги, метаданные и текстовые описания в ChromaDB.
