# Согласованность разметки и кластеризация (явные / неявные / красные)

## Текущая схема классов

- **Красный** — мастоциты, которые практически не видны (низкая уверенность, без ИГХ не подтвердить).
- **Зелёный** — явные мастоциты.
- **Синий** — неявные мастоциты.

В скриптах анализа (`analyze_mast_cells_coordinates_gemini.py`) и в резюме для Gemini используются только **зелёный = явный** и **синий = неявный**. Красный как отдельный класс в промптах не фигурирует.

---

## Корректна ли такая трёхклассовая схема с точки зрения Gemini?

**Да, схема логична и согласуется с выводами Gemini:**

1. **Явные / неявные** — это ровно то разделение, которое Gemini уже использует и описывает (чёткая зернистость и контраст vs размытые границы, низкий контраст).
2. **Третий класс (красный — «практически не видны»)** — это по сути **уровень уверенности**, а не новый морфологический тип:
   - можно трактовать как «явный/неявный + уверенность: очень низкая» или «требуется ИГХ»;
   - в документации (MAST_CELLS_COORDINATES_ANALYSIS_SUMMARY.md) явно сказано: для неявных мастоцитов для 100% уверенности нужен ИГХ — красный естественно ложится в эту зону.

**Рекомендация:** для обучения и для единого формата **явные/неявные** можно:
- либо оставить красный как отдельный класс «неопределённые / только с ИГХ»;
- либо сводить красный к неявным с меткой `confidence: low` или `requires_ihc: true`, чтобы не плодить лишние классы в модели.

Имеет смысл один раз спросить Gemini по нескольким примерам _yes с красной разметкой: «Все аннотации на этом изображении — явные, неявные или неопределённые? Предложи единый формат: явный/неявный.» и зафиксировать правила сведения красного в явный/неявный.

---

## Может ли Gemini кластеризовать похожие изображения и выявить «перемешанные» группы?

**Да, в двух смыслах:**

### 1. Вербально (прямо по разметке)

- Отправлять Gemini пары или батчи изображений _yes и спрашивать:
  - «По этим изображениям с разметкой: какие аннотации ты бы отнёс к явным, какие к неявным, какие к неопределённым (красным)?»
  - «Есть ли несогласованность: объекты, которые на одном снимке помечены как явные, а на другом как неявные при похожей морфологии?»
- Так можно **выявить субъективность** и **привести к единому формату явные/неявные** (и при необходимости оставить красный как «только с ИГХ»).

### 2. Через инструменты кластеризации (эмбеддинги + кластеры)

- **CLIP-эмбеддинги** по изображениям _yes (или _no) уже есть в пайплайне (`train_knowledge_base.py`, `search_similar_images`). По ним можно:
  - кластеризовать изображения (например, KMeans, HDBSCAN);
  - смотреть, как в каждом кластере распределены ваши метки (зелёный/синий/красный), если их извлечь из изображений или завести таблицу вручную.
- Кластеры, где **смешаны зелёный и синий** (или красный с обоими), — кандидаты на **переразметку или проверку экспертом/Gemini**, чтобы привести к единому формату явные/неявные.

То есть: **кластеризация по визуальному сходству (CLIP) не заменяет решение «явный/неявный», но указывает, где разметка, скорее всего, непоследовательна** — там, где визуально похожие слайды размечены по-разному.

---

## Какие методы кластеризации по классам можно применять дальше?

### На уровне тулзов (эмбеддинги + кластеры)

| Метод | Что делаем | Зачем |
|--------|------------|--------|
| **CLIP + KMeans / HDBSCAN** | Кластеризуем изображения _yes (или _no) по эмбеддингам | Группы визуально похожих снимков; затем смотрим распределение меток (зелёный/синий/красный) по группам |
| **Эмбеддинги по «подписи разметки»** | По каждому _yes считаем, сколько аннотаций зелёных/синих/красных (по цвету пикселей или по таблице) | Кластеризуем по вектору (n_green, n_blue, n_red) или по доле классов; находим снимки с похожей «смесью» классов |
| **Комбинированный признак** | Конкатенация или отдельные кластеры: CLIP-эмбеддинг + вектор разметки | Более тонкое выявление «визуально похожие, но по-разному размеченные» |

Скрипт **`scripts/cluster_mast_annotations.py`** делает первый шаг: кластеризация _yes по CLIP и (опционально) подсчёт красных/зелёных/синих пикселей разметки и вывод списка файлов по кластерам. Отчёт сохраняется в `mast_dir/cluster_report.json`.

Примеры запуска:
```bash
# Кластеризация по CLIP (нужны sentence-transformers и scikit-learn)
python scripts/cluster_mast_annotations.py --mast_dir data/MAST_GEMINI/test

# Только статистика по цветам разметки (без CLIP)
python scripts/cluster_mast_annotations.py --mast_dir data/MAST_GEMINI/test --color_stats --no_clip

# CLIP + цветовая статистика, 4 кластера
python scripts/cluster_mast_annotations.py --mast_dir data/MAST_GEMINI/test --color_stats --n_clusters 4
```

Дальше можно добавить экспорт в CSV (файл, кластер, n_red, n_green, n_blue) и флаг «mixed» для кластеров с разными типами разметки.

### На уровне вербальных описаний (Gemini)

- **Батч-классификация:** для каждого _yes (или для каждого аннотированного объекта по вырезкам) запрашивать у Gemini: «явный / неявный / неопределённый» + краткое обоснование. Затем сравнивать с текущей разметкой (зелёный/синий/красный) и помечать расхождения.
- **Валидация кластеров:** после того как CLIP выдал группы, отправить по 1–2 представителя каждой группы Gemini с вопросом: «Опиши тип разметки (явные/неявные/неопределённые) и предложи единый формат для всех снимков этой группы.»

Так вы и **приведёте классы к единому формату явные/неявные**, и **решите, как обрабатывать красный** (отдельный класс или подкласс неявных с низкой уверенностью).

---

## Нужно ли больше примеров?

**Да.** В документации (DATASETS_FOR_KB.md, GEMINI_DATASET_REQUIREMENTS.md) указано:

- для сложных случаев (неявные, веретеновидные, дегранулированные, кластеры и т.д.) — **порядка 50–100+ примеров по типам**;
- у вас в `data/MAST_GEMINI/test/` сейчас **11 пар** (_no / _yes) — этого достаточно для пилота и проверки идей по кластеризации, но мало для устойчивого обучения и калибровки явный/неявный.

Рекомендация: использовать текущие 11 пар для:
1) проверки скрипта кластеризации и выявления «перемешанных» групп;  
2) одного-двух циклов вопросов к Gemini (согласованность разметки, единый формат явные/неявные);  
а затем наращивать датасет до десятков примеров по каждому типу (явные, неявные, пограничные/красные).

---

## Краткий чеклист

1. **Три класса (красный/зелёный/синий)** — логичны; для единого формата явные/неявные стоит зафиксировать правило для красного (отдельный класс или неявный + low confidence).
2. **Gemini** может и кластеризовать «по смыслу» (вербально), и помогать привести разметку к одному формату; **инструментальная кластеризация** (CLIP + подсчёт цветов разметки) выявляет группы, где классы перемешаны.
3. **Методы:** CLIP + KMeans/HDBSCAN по изображениям; кластеризация по вектору (n_green, n_blue, n_red); батч-классификация и валидация кластеров через Gemini.
4. **Примеров** для надёжных выводов нужно больше — текущий test-набор удобен для отладки пайплайна и согласованности разметки.
