# Анализ мастоцитов через Gemini 3 Pro

Скрипт для анализа изображений мастоцитов с целью определения признаков для разметки на неокрашенных патчах.

## Задача

Определить, видит ли Gemini 3 Pro признаки для разметки мастоцитов на неокрашенных патчах (стандартное окрашивание гематоксилин-эозин). Может ли модель сама их найти или дать внятное описание для разметчика.

## Структура данных

В директории `MAST_GEMINI/` находятся пары изображений:

- `N.png` — стандартное окрашивание гематоксилин-эозин (г/э) с аннотациями:
  - **Зеленым** выделены мастоциты с **явными признаками**
  - **Синим** выделены мастоциты с **не очень явными признаками**
- `N_игх.png` — те же мастоциты на окрашивании **ИГХ** (иммуногистохимия)

## Установка зависимостей

```bash
pip install httpx python-dotenv
```

## Настройка

Скрипт использует конфигурацию из:
1. `../brats/kb-service/config.env` (приоритет)
2. `../brats/config.env` (резерв)

Необходимые переменные окружения:
- `GEMINI_API_KEY` или `OPENAI_API_KEY` — API ключ для ProxyAPI.ru
- `GEMINI_BASE_URL` (опционально, по умолчанию `https://api.proxyapi.ru/google`)
- `GEMINI_MODEL` (опционально, по умолчанию `gemini-3-pro-preview`)

Пример конфигурации в `kb-service/config.env`:
```env
GEMINI_API_KEY=your_proxyapi_key_here
GEMINI_BASE_URL=https://api.proxyapi.ru/google
GEMINI_MODEL=gemini-3-pro-preview
```

## Использование

```bash
cd /mnt/ai/cnn/sc
python3 analyze_mast_cells_gemini.py
```

Скрипт работает в **batch-режиме**:
1. Загружает все пары изображений из `MAST_GEMINI/`
2. Для каждой пары (г/э + ИГХ) создает отдельный запрос
3. **Отправляет все запросы параллельно** (batch-режим) для ускорения и экономии
4. Получает анализ признаков мастоцитов для каждой пары
5. Формирует итоговый отчет со всеми результатами
6. Сохраняет результат в `mast_cells_analysis_result.txt`

### Преимущества batch-режима:
- **Параллельная обработка** - все пары анализируются одновременно
- **Экономия времени** - быстрее чем последовательная обработка
- **Структурированные результаты** - каждая пара имеет свой раздел в отчете
- **Адаптированный промпт** - промпт оптимизирован для анализа одной пары за раз

## Промпт для Gemini

Скрипт использует **адаптированный промпт для batch-режима**. Для каждой пары изображений задаются следующие вопросы:

1. **Видит ли модель признаки мастоцитов** на неокрашенном патче (г/э) для этой конкретной пары?
   - Конкретные визуальные признаки (форма, размер, цвет, текстура, расположение)

2. **Может ли модель сама найти и разметить** мастоциты на этом патче?
   - Краткий алгоритм (на что смотреть, какие признаки использовать)
   - Или что нужно дополнительно

3. **Может ли дать внятное описание** для разметчика?
   - Визуальные характеристики мастоцитов на г/э для этой пары
   - Важные морфологические признаки
   - Различия между зелеными (явные) и синими (не очень явные) аннотациями

4. **Сравнение с ИГХ** для этой пары:
   - Насколько хорошо видны мастоциты на г/э по сравнению с ИГХ
   - Какие признаки сохраняются, какие теряются

**Особенность batch-промпта**: промпт адаптирован для анализа одной пары за раз, что позволяет получить более точные и конкретные ответы для каждого случая.

## Результат

Результат сохраняется в `mast_cells_analysis_result.txt` и выводится в консоль.

**Структура отчета:**
- Общая информация о количестве проанализированных пар
- Для каждой пары отдельный раздел с:
  - Номером пары и именем файла
  - Статусом анализа (success/error)
  - Детальным результатом анализа
- Обобщающий раздел (планируется добавить автоматическое обобщение)

## Устранение проблем

### Ошибка 402: Insufficient balance

Если появляется ошибка `402 Payment Required`, это означает недостаточный баланс на ProxyAPI.ru.

**Решения:**
1. Пополните баланс на ProxyAPI.ru
2. Используйте другой API ключ с достаточным балансом

**Примечание:** Batch-режим отправляет запросы параллельно, что может быть более эффективно по стоимости, чем отправка всех изображений в одном большом запросе.

### Изображения не найдены

Убедитесь, что директория `MAST_GEMINI/` существует и содержит файлы:
- `1.png`, `2.png`, `3.png`, `4.png` (изображения г/э)
- `1_игх.png`, `2_игх.png`, `3_игх.png`, `4_игх.png` (изображения ИГХ)

## Технические детали

### Batch-режим

Скрипт использует `asyncio.gather()` для параллельного выполнения всех запросов к Gemini API. Это означает:
- Все пары изображений анализируются одновременно
- Время выполнения ≈ времени самого медленного запроса (а не сумме всех запросов)
- Каждый запрос независим, ошибка в одной паре не влияет на другие

### Адаптация промпта

Промпт адаптирован для batch-режима:
- Использует шаблон с плейсхолдерами (`{pair_id}`, `{img_g_e_name}`, `{img_ihc_name}`)
- Для каждой пары создается индивидуальный промпт
- Промпт оптимизирован для анализа одной пары, что дает более точные результаты

